<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounting - Civitas</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <link rel="stylesheet" th:href="@{/css/sidebar.css}" />
    <link rel="stylesheet" th:href="@{/css/header.css}" />
    <link rel="stylesheet" th:href="@{/css/accounting.css}" />

    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <script th:src="@{/js/sidebar.js}" defer></script>
    <script th:src="@{/js/header.js}" defer></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
</head>
<body>

<div th:replace="~{fragments :: sidebar}"></div>
<div th:replace="~{fragments :: header}"></div>

<main class="main-content accounting-container">

    <div class="stats-row">
        <div class="stat-card income">
            <h3>Total Income</h3>
            <p class="stat-value" th:text="${'€ ' + #numbers.formatDecimal(totalIncome, 1, 2)}">€ 0.00</p>
        </div>
        <div class="stat-card expense">
            <h3>Total Expenses</h3>
            <p class="stat-value" th:text="${'€ ' + #numbers.formatDecimal(totalExpense, 1, 2)}">€ 0.00</p>
        </div>
        <div class="stat-card balance">
            <h3>Current Balance</h3>
            <p class="stat-value" th:text="${'€ ' + #numbers.formatDecimal(balance, 1, 2)}">€ 0.00</p>
        </div>
    </div>

    <div class="accounting-wrapper">

        <div class="section-header">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('income')">Inkomsten</button>
                <button class="tab-btn" onclick="switchTab('expense')">Uitgaven</button>
            </div>

            <input type="file" id="fileUpload" style="display: none" accept=".pdf, .png, .jpg" onchange="handleFileUpload(this)">

            <button class="add-btn" onclick="document.getElementById('fileUpload').click()">
                <i class="fa-solid fa-cloud-arrow-up"></i> Upload Invoice
            </button>
        </div>

        <div id="tab-income" class="tab-content active">
            <table class="data-table">
                <thead>
                <tr>
                    <th>Date</th>
                    <th>Counterparty</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="inv : ${incomes}">
                    <td th:text="${inv.invoiceDate}">2025-01-01</td>
                    <td th:text="${inv.counterparty}">Sponsor A</td>
                    <td th:text="${inv.category}">Sponsorship</td>
                    <td class="amount-positive" th:text="${'€ ' + inv.totalAmount}">€ 100</td>
                    <td>
                        <a th:href="@{'/uploads/invoices/' + ${inv.fileUrl}}" target="_blank" class="icon-btn" title="View PDF">
                            <i class="fa-solid fa-file-pdf"></i>
                        </a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div id="tab-expense" class="tab-content">
            <table class="data-table">
                <thead>
                <tr>
                    <th>Date</th>
                    <th>Counterparty</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="inv : ${expenses}">
                    <td th:text="${inv.invoiceDate}">2025-01-01</td>
                    <td th:text="${inv.counterparty}">Hosting</td>
                    <td th:text="${inv.category}">Infra</td>
                    <td class="amount-negative" th:text="${'€ ' + inv.totalAmount}">€ 50</td>
                    <td>
                        <a th:href="@{'/uploads/invoices/' + ${inv.fileUrl}}" target="_blank" class="icon-btn">
                            <i class="fa-solid fa-file-pdf"></i>
                        </a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<div id="reviewModal" class="modal">
    <div class="modal-content dual-pane">

        <div class="modal-left">
            <h3>Scanned Document</h3>
            <iframe id="pdfPreview" src="" width="100%" height="500px"></iframe>
        </div>

        <div class="modal-right">
            <h3>Verify Data</h3>
            <p class="helper-text">Our scanner guessed this data. Please verify.</p>

            <form id="verifyForm">
                <input type="hidden" id="hiddenFileUrl">
                <input type="hidden" id="hiddenOriginalName">

                <div class="form-group">
                    <label>Type</label>
                    <select id="inputInvoiceType">
                        <option value="INCOME">Income (Inkomsten)</option>
                        <option value="EXPENSE">Expense (Uitgaven)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Counterparty</label>
                    <input type="text" id="inputCounterparty">
                </div>

                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="inputDate">
                </div>

                <div class="form-group">
                    <label>Total Amount (€)</label>
                    <input type="number" step="0.01" id="inputAmount">
                </div>

                <div class="form-group">
                    <label>Category</label>
                    <input type="text" id="inputCategory" placeholder="e.g. Hosting, Office">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                    <button type="button" class="btn-save" onclick="saveInvoice()">Confirm & Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="spinner"></div>
    <p>Scanning Invoice...</p>
</div>

<script th:src="@{/js/accounting.js}"></script>
</body>
</html>