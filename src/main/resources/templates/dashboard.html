<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/sidebar.css}" />
    <link rel="stylesheet" th:href="@{/css/dashboard.css}" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script th:src="@{/js/sidebar.js}" defer></script>
    <style>
        .kpi-tile { position: relative; }
        .remove-btn {
            position: absolute;
            top: 5px; right: 5px;
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 1.2rem;
        }
        .remove-btn:hover { color: red; }
        .add-kpi-container {
            margin-top: 20px;
        }
    </style>
</head>
<body>

<!-- Sidebar -->
<div th:replace="~{fragments :: sidebar}"></div>

<!-- Main content -->
<main class="members-container">
    <div class="members-header">
        <h1 class="title">Dashboard</h1>
    </div>

    <!-- KPI Tiles -->
    <div class="tiles-container" id="tiles-container"></div>

    <!-- Add KPI -->
    <div class="add-kpi-container">
        <label for="kpi-select">Add KPI:</label>
        <select id="kpi-select"></select>
        <button id="add-kpi-btn">Add</button>
    </div>
</main>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const userId = 1; // Replace with Thymeleaf session user ID
        const container = document.getElementById('tiles-container');
        const kpiSelect = document.getElementById('kpi-select');

        let allTiles = [];
        let activeTiles = [];

        // Fetch all available tiles
        fetch(`/api/dashboard/tiles`)
            .then(res => res.json())
            .then(data => {
                allTiles = data;
                refreshSelect();
            });

        // Fetch user dashboard
        fetch(`/api/dashboard/users/${userId}`)
            .then(res => res.json())
            .then(data => {
                activeTiles = data;
                renderTiles();
                refreshSelect();
            });

        // Render KPI tiles
        function renderTiles() {
            container.innerHTML = "";
            activeTiles.forEach(kpi => {
                const tile = document.createElement('div');
                tile.classList.add('kpi-tile');
                tile.innerHTML = `
                    <button class="remove-btn" data-key="${kpi.key}">&times;</button>
                    <div class="kpi-header">
                        <i class="fas fa-chart-simple"></i>
                        <h3>${kpi.title}</h3>
                    </div>
                    <p class="kpi-value">${kpi.formattedValue}</p>
                `;
                container.appendChild(tile);
            });

            // Add remove listeners
            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const key = this.dataset.key;
                    removeKpi(key);
                });
            });
        }

        // Refresh "Add KPI" select box
        function refreshSelect() {
            const activeKeys = new Set(activeTiles.map(k => k.key));
            kpiSelect.innerHTML = "";
            allTiles
                .filter(t => !activeKeys.has(t.key))
                .forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.key;
                    option.textContent = t.title;
                    kpiSelect.appendChild(option);
                });
        }

        // Remove KPI from dashboard
        function removeKpi(key) {
            fetch(`/api/dashboard/users/${userId}/tiles/${key}`, { method: 'DELETE' })
                .then(() => {
                    activeTiles = activeTiles.filter(k => k.key !== key);
                    renderTiles();
                    refreshSelect();
                });
        }

        // Add KPI to dashboard
        document.getElementById('add-kpi-btn').addEventListener('click', function() {
            const key = kpiSelect.value;
            if (!key) return;

            fetch(`/api/dashboard/users/${userId}/tiles/${key}`, { method: 'POST' })
                .then(() => {
                    const tileMeta = allTiles.find(t => t.key === key);
                    activeTiles.push({
                        key: tileMeta.key,
                        title: tileMeta.title,
                        formattedValue: "Loading..."
                    });
                    renderTiles();
                    refreshSelect();
                });
        });
    });
</script>

</body>
</html>
