<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <title>Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/sidebar.css}" />
    <link rel="stylesheet" th:href="@{/css/dashboard.css}" />

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script th:src="@{/js/sidebar.js}" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

</head>
<body>

<!-- Sidebar -->
<div th:replace="~{fragments :: sidebar}"></div>

<!-- Main Dashboard -->
<main class="dashboard-container">
    <div class="dashboard-header">
        <h1 class="dashboard-title">Dashboard</h1>
        <p class="dashboard-subtitle">Overview of your key metrics and performance indicators</p>
    </div>

    <div class="dashboard-grid">
        <!-- Total Members - Small Card -->
        <div class="kpi-card kpi-small" id="total-members">
            <div class="kpi-header">
                <h3 class="kpi-title">Total Members</h3>
                <div class="kpi-icon">
                    <i class="fas fa-users"></i>
                </div>
            </div>
            <div class="kpi-value" id="total-members-value">-</div>
            <div class="kpi-change positive">
                <i class="fas fa-arrow-up"></i>
                <span>12% vs last month</span>
            </div>
        </div>

        <!-- Active Members - Small Card -->
        <div class="kpi-card kpi-small" id="active-members">
            <div class="kpi-header">
                <h3 class="kpi-title">Active Members</h3>
                <div class="kpi-icon">
                    <i class="fas fa-user-check"></i>
                </div>
            </div>
            <div class="kpi-value" id="active-members-value">-</div>
            <div class="kpi-change positive">
                <i class="fas fa-arrow-up"></i>
                <span>8% vs last month</span>
            </div>
        </div>

        <!-- Revenue - Medium Card with Chart -->
        <div class="kpi-card kpi-medium" id="revenue-card">
            <div class="kpi-header">
                <h3 class="kpi-title">Revenue This Month</h3>
                <div class="kpi-icon">
                    <i class="fas fa-euro-sign"></i>
                </div>
            </div>
            <div class="kpi-value" id="revenue-value">-</div>
            <div class="kpi-change positive">
                <i class="fas fa-arrow-up"></i>
                <span>15% vs last month</span>
            </div>
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- Monthly Growth - Small Card -->
        <div class="kpi-card kpi-small" id="growth-card">
            <div class="kpi-header">
                <h3 class="kpi-title">Monthly Growth</h3>
                <div class="kpi-icon">
                    <i class="fas fa-trending-up"></i>
                </div>
            </div>
            <div class="kpi-value" id="growth-value">-</div>
            <div class="kpi-change positive">
                <i class="fas fa-arrow-up"></i>
                <span>New members</span>
            </div>
        </div>

        <!-- Failed Payments - Medium Card -->
        <div class="kpi-card kpi-medium" id="failed-payments">
            <div class="kpi-header">
                <h3 class="kpi-title">Failed Payments</h3>
                <div class="kpi-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
            </div>
            <div class="kpi-value" id="failed-payments-value">-</div>
            <div class="kpi-stats" id="failed-payments-stats">
                <div class="stat-row">
                    <span class="stat-label">This Week</span>
                    <span class="stat-value">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Last Week</span>
                    <span class="stat-value">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Recovery Rate</span>
                    <span class="stat-value">-</span>
                </div>
            </div>
        </div>

        <!-- Upcoming Events - Large Card -->
        <div class="kpi-card kpi-large" id="upcoming-events">
            <div class="kpi-header">
                <h3 class="kpi-title">Upcoming Events</h3>
                <div class="kpi-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
            </div>
            <div class="kpi-value" id="events-count">-</div>
            <ul class="kpi-list" id="events-list">
                <li class="kpi-list-item">Loading events...</li>
            </ul>
        </div>
    </div>
</main>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const userId = 1;
        let revenueChart;

        // Initialize revenue chart
        function initRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        data: [1200, 1800, 1600, 2100],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    elements: {
                        point: { radius: 0 }
                    }
                }
            });
        }

        // Load KPI data using your existing API
        function loadKPIs() {
            fetch(`/api/dashboard/users/${userId}`)
                .then(res => res.json())
                .then(kpis => {
                    // Process each KPI from the response
                    kpis.forEach(kpi => updateKPI(kpi.key, kpi));
                })
                .catch(error => console.error('Error loading KPIs:', error));
        }

        // Update individual KPI displays
        function updateKPI(key, data) {
            switch(key) {
                case 'members.total.count':
                    document.getElementById('total-members-value').textContent = data.formattedValue;
                    break;

                case 'members.active.count':
                    document.getElementById('active-members-value').textContent = data.formattedValue;
                    break;

                case 'stripe.totalRevenueMonth':
                    document.getElementById('revenue-value').textContent = data.formattedValue;
                    break;

                case 'members.growth.month':
                    document.getElementById('growth-value').textContent = data.formattedValue;
                    break;

                case 'transactions.failed':
                    const failedCount = Array.isArray(data.value) ? data.value.length : data.value;
                    document.getElementById('failed-payments-value').textContent = failedCount;

                    // Update failed payments stats
                    const statsContainer = document.getElementById('failed-payments-stats');
                    if (Array.isArray(data.value)) {
                        // You can enhance this with more sophisticated stats
                        statsContainer.querySelector('.stat-row:nth-child(1) .stat-value').textContent = Math.floor(failedCount / 2);
                        statsContainer.querySelector('.stat-row:nth-child(2) .stat-value').textContent = Math.floor(failedCount / 3);
                        statsContainer.querySelector('.stat-row:nth-child(3) .stat-value').textContent = '85%';
                    }
                    break;

                case 'events.upcoming':
                    const eventsList = document.getElementById('events-list');
                    const eventsCount = document.getElementById('events-count');

                    if (Array.isArray(data.value) && data.value.length > 0) {
                        eventsCount.textContent = data.value.length;
                        eventsList.innerHTML = data.value.slice(0, 5).map(event =>
                            `<li class="kpi-list-item">${event}</li>`
                        ).join('');
                    } else {
                        eventsCount.textContent = '0';
                        eventsList.innerHTML = '<li class="kpi-list-item">No upcoming events</li>';
                    }
                    break;
            }
        }

        // Initialize everything
        initRevenueChart();
        loadKPIs();

        // Refresh data every 5 minutes
        setInterval(loadKPIs, 5 * 60 * 1000);
    });
</script>

</body>
</html>