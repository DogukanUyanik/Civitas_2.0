<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Member Details</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.0/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/sidebar.css}" />
    <link rel="stylesheet" th:href="@{/css/memberDetails.css}" />

    <script th:src="@{/js/sidebar.js}" defer></script>
</head>
<body>
<div th:replace="~{fragments :: sidebar}"></div>

<div class="members-container container">
    <h1 class="title">Member Details</h1>
    <div class="row">
        <!-- Left Panel: Member Info -->
        <div class="col-md-4">
            <div class="panel member-info">
                <!-- Profile Section -->
                <div class="profile-section">
                    <div class="profile-avatar">
                        <i class="bi bi-person-fill"></i>
                    </div>
                    <h2 class="profile-name">[[${member.firstName}]] [[${member.lastName}]]</h2>
                    <div class="profile-id">Member ID: [[${member.id}]]</div>
                    <div class="profile-status" th:class="'profile-status ' + ${member.memberStatus}" th:text="${member.memberStatus}">Active</div>
                </div>

                <!-- Personal Details Section -->
                <div class="personal-details">
                    <h3 class="section-title">
                        <i class="bi bi-person-lines-fill"></i>
                        Personal Details
                    </h3>

                    <div class="detail-item">
                        <i class="bi bi-envelope-fill"></i>
                        <span class="detail-label">Email:</span>
                        <span class="detail-value" th:text="${member.email}">mark.andrews@gmail.com</span>
                    </div>

                    <div class="detail-item">
                        <i class="bi bi-telephone-fill"></i>
                        <span class="detail-label">Phone:</span>
                        <span class="detail-value" th:text="${member.phoneNumber}">+91 98765 43210</span>
                    </div>

                    <div class="detail-item">
                        <i class="bi bi-geo-alt-fill"></i>
                        <span class="detail-label">Address:</span>
                        <span class="detail-value" th:text="${member.address}">ABC Gym - Riyadh</span>
                    </div>

                    <div class="detail-item">
                        <i class="bi bi-calendar-check-fill"></i>
                        <span class="detail-label">Last Payment:</span>
                        <span class="detail-value" th:text="${member.dateOfLastPayment}">31 May, 2023</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Transactions Table -->
        <div class="col-md-8">
            <div class="panel transactions-table-wrapper">
                <!-- Transactions Header -->
                <div class="transactions-header">
                    <h3 class="transactions-title">
                        <i class="bi bi-receipt"></i>
                        Transaction History
                    </h3>

                    <!-- Filter Controls -->
                    <div class="filter-controls">
                        <div class="filter-group">
                            <label class="filter-label">Date Range:</label>
                            <select class="filter-select" id="dateFilter">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">Last 7 Days</option>
                                <option value="month">Last Month</option>
                                <option value="quarter">Last 3 Months</option>
                                <option value="year">Last Year</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Status:</label>
                            <select class="filter-select" id="statusFilter">
                                <option value="all">All Status</option>
                                <option value="SUCCEEDED">Succeeded</option>
                                <option value="PENDING">Pending</option>
                                <option value="FAILED">Failed</option>
                                <option value="CANCELLED">Cancelled</option>
                            </select>
                        </div>

                        <button class="filter-reset-btn" id="resetFilters">
                            <i class="bi bi-arrow-clockwise"></i>
                            Reset
                        </button>
                    </div>
                </div>

                <!-- Transactions Table -->
                <div class="table-container">
                    <table class="transactions-table" id="transactionsTable">
                        <thead>
                        <tr>
                            <th class="sortable" data-column="date">
                                <i class="bi bi-calendar3"></i>
                                Date
                                <i class="bi bi-chevron-expand sort-icon"></i>
                            </th>
                            <th class="sortable" data-column="type">
                                <i class="bi bi-tag"></i>
                                Type
                                <i class="bi bi-chevron-expand sort-icon"></i>
                            </th>
                            <th class="sortable" data-column="amount">
                                <i class="bi bi-currency-dollar"></i>
                                Amount
                                <i class="bi bi-chevron-expand sort-icon"></i>
                            </th>
                            <th class="sortable" data-column="currency">
                                <i class="bi bi-cash"></i>
                                Currency
                                <i class="bi bi-chevron-expand sort-icon"></i>
                            </th>
                            <th class="sortable" data-column="status">
                                <i class="bi bi-check-circle"></i>
                                Status
                                <i class="bi bi-chevron-expand sort-icon"></i>
                            </th>
                        </tr>
                        </thead>
                        <tbody id="transactionsBody">
                        <tr th:each="tx : ${member.transactions}"
                            th:attr="data-date=${#temporals.format(tx.createdAt, 'yyyy-MM-dd')},
                                     data-status=${tx.status},
                                     data-amount=${tx.amount},
                                     data-type=${tx.type},
                                     data-currency=${tx.currency}">
                            <td class="date-cell" th:text="${#temporals.format(tx.createdAt, 'dd/MM/yyyy HH:mm')}"></td>
                            <td class="type-cell" th:text="${tx.type}"></td>
                            <td class="amount-cell" th:text="${tx.amount}"></td>
                            <td class="currency-cell" th:text="${tx.currency}"></td>
                            <td class="status-cell">
                                <span th:text="${tx.status}" th:class="'status-pill ' + ${tx.status}"></span>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(member.transactions)}" class="no-data-row">
                            <td colspan="5" class="text-center">
                                <i class="bi bi-inbox" style="font-size: 2rem; color: #cbd5e0; margin-bottom: 0.5rem;"></i><br>
                                No transactions found
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Script loaded'); // Debug log

        const table = document.getElementById('transactionsTable');
        const tbody = document.getElementById('transactionsBody');
        const dateFilter = document.getElementById('dateFilter');
        const statusFilter = document.getElementById('statusFilter');
        const resetBtn = document.getElementById('resetFilters');
        const noDataRow = document.querySelector('.no-data-row');

        console.log('Elements found:', { table, tbody, dateFilter, statusFilter, resetBtn, noDataRow }); // Debug log

        let currentSort = { column: 'date', direction: 'desc' };

        // Check if elements exist before proceeding
        if (!table || !tbody) {
            console.error('Table elements not found');
            return;
        }

        // Initialize - sort by date descending by default
        setTimeout(() => {
            sortTable('date', 'desc');
        }, 100);

        // Add click listeners to sortable headers
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', function() {
                console.log('Header clicked:', this.dataset.column); // Debug log
                const column = this.dataset.column;
                let direction = 'asc';

                if (currentSort.column === column && currentSort.direction === 'asc') {
                    direction = 'desc';
                }

                sortTable(column, direction);
            });
        });

        // Add filter listeners
        if (dateFilter) {
            dateFilter.addEventListener('change', function() {
                console.log('Date filter changed:', this.value); // Debug log
                applyFilters();
            });
        }

        if (statusFilter) {
            statusFilter.addEventListener('change', function() {
                console.log('Status filter changed:', this.value); // Debug log
                applyFilters();
            });
        }

        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                console.log('Reset button clicked'); // Debug log
                resetFilters();
            });
        }

        function sortTable(column, direction) {
            console.log('Sorting by:', column, direction); // Debug log

            const rows = Array.from(tbody.querySelectorAll('tr:not(.no-data-row)'));
            console.log('Found rows:', rows.length); // Debug log

            if (rows.length === 0) {
                console.log('No rows to sort');
                return;
            }

            rows.sort((a, b) => {
                let aValue, bValue;

                switch(column) {
                    case 'date':
                        // Get date from the actual cell text
                        const aDateText = a.querySelector('.date-cell')?.textContent || '';
                        const bDateText = b.querySelector('.date-cell')?.textContent || '';

                        // Parse date in format dd/MM/yyyy HH:mm
                        aValue = parseDateFromText(aDateText);
                        bValue = parseDateFromText(bDateText);
                        break;

                    case 'amount':
                        const aAmountText = a.querySelector('.amount-cell')?.textContent || '0';
                        const bAmountText = b.querySelector('.amount-cell')?.textContent || '0';
                        aValue = parseFloat(aAmountText.replace(/[^\d.-]/g, '')) || 0;
                        bValue = parseFloat(bAmountText.replace(/[^\d.-]/g, '')) || 0;
                        break;

                    case 'type':
                        aValue = (a.querySelector('.type-cell')?.textContent || '').toLowerCase().trim();
                        bValue = (b.querySelector('.type-cell')?.textContent || '').toLowerCase().trim();
                        break;

                    case 'currency':
                        aValue = (a.querySelector('.currency-cell')?.textContent || '').toLowerCase().trim();
                        bValue = (b.querySelector('.currency-cell')?.textContent || '').toLowerCase().trim();
                        break;

                    case 'status':
                        aValue = (a.querySelector('.status-cell .status-pill')?.textContent || '').toLowerCase().trim();
                        bValue = (b.querySelector('.status-cell .status-pill')?.textContent || '').toLowerCase().trim();
                        break;

                    default:
                        return 0;
                }

                console.log('Comparing:', aValue, 'vs', bValue); // Debug log

                if (aValue < bValue) return direction === 'asc' ? -1 : 1;
                if (aValue > bValue) return direction === 'asc' ? 1 : -1;
                return 0;
            });

            // Update UI
            updateSortUI(column, direction);
            currentSort = { column, direction };

            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
            if (noDataRow) {
                tbody.appendChild(noDataRow); // Keep no-data row at the end
            }

            console.log('Sort completed'); // Debug log
        }

        function parseDateFromText(dateText) {
            if (!dateText) return new Date(0);

            try {
                // Parse format: dd/MM/yyyy HH:mm
                const parts = dateText.split(' ');
                const datePart = parts[0]; // dd/MM/yyyy
                const timePart = parts[1] || '00:00'; // HH:mm

                const dateComponents = datePart.split('/');
                const timeComponents = timePart.split(':');

                if (dateComponents.length === 3 && timeComponents.length === 2) {
                    const day = parseInt(dateComponents[0]);
                    const month = parseInt(dateComponents[1]) - 1; // Month is 0-indexed
                    const year = parseInt(dateComponents[2]);
                    const hour = parseInt(timeComponents[0]);
                    const minute = parseInt(timeComponents[1]);

                    return new Date(year, month, day, hour, minute);
                }
            } catch (e) {
                console.error('Error parsing date:', dateText, e);
            }

            return new Date(0);
        }

        function updateSortUI(column, direction) {
            // Remove all existing sort classes
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });

            // Add appropriate class to current sorted column
            const currentHeader = document.querySelector(`[data-column="${column}"]`);
            if (currentHeader) {
                currentHeader.classList.add(direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }
        }

        function applyFilters() {
            if (!dateFilter || !statusFilter) return;

            const dateValue = dateFilter.value;
            const statusValue = statusFilter.value;
            const rows = tbody.querySelectorAll('tr:not(.no-data-row)');
            let visibleCount = 0;

            console.log('Applying filters - Date:', dateValue, 'Status:', statusValue); // Debug log

            rows.forEach(row => {
                let showRow = true;

                // Date filter
                if (dateValue !== 'all') {
                    const dateText = row.querySelector('.date-cell')?.textContent || '';
                    const rowDate = parseDateFromText(dateText);
                    const now = new Date();
                    let cutoffDate;

                    switch(dateValue) {
                        case 'today':
                            cutoffDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            break;
                        case 'week':
                            cutoffDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            break;
                        case 'month':
                            cutoffDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                            break;
                        case 'quarter':
                            cutoffDate = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
                            break;
                        case 'year':
                            cutoffDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
                            break;
                    }

                    if (cutoffDate && rowDate < cutoffDate) {
                        showRow = false;
                    }
                }

                // Status filter
                if (statusValue !== 'all') {
                    const rowStatus = row.querySelector('.status-cell .status-pill')?.textContent?.trim() || '';
                    if (rowStatus.toUpperCase() !== statusValue.toUpperCase()) {
                        showRow = false;
                    }
                }

                if (showRow) {
                    row.classList.remove('hidden');
                    visibleCount++;
                } else {
                    row.classList.add('hidden');
                }
            });

            console.log('Visible rows after filtering:', visibleCount); // Debug log

            // Show/hide no data message
            if (noDataRow) {
                if (visibleCount === 0) {
                    noDataRow.classList.add('show');
                } else {
                    noDataRow.classList.remove('show');
                }
            }
        }

        function resetFilters() {
            if (dateFilter) dateFilter.value = 'all';
            if (statusFilter) statusFilter.value = 'all';
            applyFilters();
            sortTable('date', 'desc'); // Reset to default sort
        }
    });
</script>
</body>
</html>